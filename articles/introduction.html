<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview of the SPIAT package • SPIAT</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Overview of the SPIAT package">
<meta property="og:description" content="SPIAT">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SPIAT</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.99.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Overview of the SPIAT package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cancer-evolution/SPIAT/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_files/header-attrs-2.6/header-attrs.js"></script><script src="introduction_files/htmlwidgets-1.5.3/htmlwidgets.js"></script><script src="introduction_files/plotly-binding-4.9.3/plotly.js"></script><script src="introduction_files/typedarray-0.1/typedarray.min.js"></script><script src="introduction_files/jquery-3.5.1/jquery.min.js"></script><link href="introduction_files/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="introduction_files/crosstalk-1.1.1/js/crosstalk.min.js"></script><link href="introduction_files/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="introduction_files/plotly-main-1.57.1/plotly-latest.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Overview of the SPIAT package</h1>
                        <h4 class="author">Anna Trigos, Tom Yang, Yuzhou Feng, Volkan Ozcoban, Maria Doyle</h4>
            
            <h4 class="date">3 February 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cancer-evolution/SPIAT/blob/master/vignettes/introduction.Rmd"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>SPIAT (<strong>Sp</strong>atial <strong>I</strong>mage <strong>A</strong>nalysis of <strong>T</strong>issues) is an R package with a suite of data processing, quality control, visualization, data handling and data analysis tools <span class="citation">(Yang et al. 2020)</span>. SPIAT is directly compatible with Opal multiplex immunohistochemistry images analysed through the HALO and InForm analysis software, but its intuitive implementation allows use with a diversity of platforms.</p>
<p>The Opal multiplex immunohistochemistry staining protocol enables 6-8 tissue markers to be used simultaneously on a single slide. It is suitable for use with formalin fixed paraffin embedded (FFPE) tissue sections, so it is also of relevance for clinical practice. The fluorescence of each marker is measured through imaging, and each cell is assigned an X,Y coordinate of its location. In effect this provides single-cell resolution. The fluorescence intensity of individual markers are then combined to identify the phenotype of the cells in the tissue.</p>
<p>SPIAT includes novel algorithms for the identification of cell clusters, cell margins and cell gradients, the calculation of neighbourhood proportions, and algorithms for the prediction of cell phenotypes in tissue images. SPIAT also includes speedy implementations of the calculation of cell distances and detection of cell communities. An overview of the functions available is shown in the figure below.</p>
<p><img width="600" alt="overview" src="https://www.biorxiv.org/content/biorxiv/early/2020/05/30/2020.05.28.122614/F1.large.jpg"></p>
</div>
<div id="setting-up-the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#setting-up-the-data" class="anchor"></a>Setting up the data</h1>
<p>First we load the SPIAT library.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SPIAT</span><span class="op">)</span></code></pre></div>
<p>We can use <code>format_image_to_sce</code> to read in and format raw data for SPIAT.<code>format_image_to_sce</code> creates a SingleCellExperiment object. It requires at least 4 arguments:</p>
<ul>
<li>
<code>format</code>: INFORM or HALO</li>
<li>
<code>image</code>: path to the raw InForm or HALO image data file</li>
<li>
<code>markers</code>: names of markers used in the OPAL staining. These must be in the same order as the marker columns in the input file, and for InForm must match the marker name used in the input file. One of the markers must be DAPI.</li>
<li>
<code>locations</code>: locations of the markers, either Nucleus, Cytoplasm or Membrane. These must be in the order of the markers. The locations are used to auto-detect the intensity (and dye) columns. Alternatively, the column names can be specified, see below for more information.</li>
</ul>
<div id="simple-import" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-import" class="anchor"></a>Simple import</h2>
<p>The simplest way to read in both InForm and HALO files, is to specify the locations of the markers as shown below. This will automatically detect the appropriate intensity (and dye) columns to use. Here we use a tiny InForm file that’s part of the SPIAT package for <code>raw_inform_data</code> but you would replace <code>system.file</code> with <code>/path/to/your/input/file</code>. For information on the InForm and HALO formats see below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_inform_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"tiny_inform.txt.gz"</span>, package <span class="op">=</span> <span class="st">"SPIAT"</span><span class="op">)</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PDL-1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Nucleus"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Membrane"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Cytoplasm"</span><span class="op">)</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"INFORM"</span>,
                          image<span class="op">=</span><span class="va">raw_inform_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                          locations<span class="op">=</span><span class="va">locations</span><span class="op">)</span></code></pre></div>
</div>
<div id="inform-input" class="section level2">
<h2 class="hasAnchor">
<a href="#inform-input" class="anchor"></a>InForm input</h2>
<div id="intensity-columns" class="section level4">
<h4 class="hasAnchor">
<a href="#intensity-columns" class="anchor"></a>Intensity columns</h4>
<p>If for some reason you don’t want to specify the <code>locations</code>, you can specify the intensity columns with <code>intensity_columns_interest</code> as shown below. This will give the same result as specifying the locations above.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_inform_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"tiny_inform.txt.gz"</span>, package <span class="op">=</span> <span class="st">"SPIAT"</span><span class="op">)</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PDL-1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">intensity_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"Nucleus DAPI (DAPI) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD3 (Opal 520) Mean (Normalized Counts, Total Weighting)"</span>, 
  <span class="st">"Membrane PDL-1 (Opal 540) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD4 (Opal 620) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD8 (Opal 650) Mean (Normalized Counts, Total Weighting)"</span>, 
  <span class="st">"Cytoplasm AMACR (Opal 690) Mean (Normalized Counts, Total Weighting)"</span>
  <span class="op">)</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"INFORM"</span>,
                          image<span class="op">=</span><span class="va">raw_inform_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                    intensity_columns_interest<span class="op">=</span><span class="va">intensity_columns_interest</span><span class="op">)</span></code></pre></div>
</div>
<div id="x-and-y-location-columns" class="section level4">
<h4 class="hasAnchor">
<a href="#x-and-y-location-columns" class="anchor"></a>X and Y location columns</h4>
<p><code>format_image_to_sce</code> uses the Cell X Position and Cell Y Position columns in the InForm raw data.</p>
</div>
<div id="phenotype-column" class="section level4">
<h4 class="hasAnchor">
<a href="#phenotype-column" class="anchor"></a>Phenotype column</h4>
<p><code>format_image_to_sce</code> uses the Phenotype column in the InForm raw data. The phenotype of a cell can be a single marker, for example, “CD3” (T cell), or a combination of markers, such as “CD3,CD4” (helper T cell). “OTHER” means a cell was positive for DAPI but no other marker.</p>
</div>
<div id="cell-properties-columns" class="section level4">
<h4 class="hasAnchor">
<a href="#cell-properties-columns" class="anchor"></a>Cell properties columns</h4>
<p>The following cell properties columns are required to be present in the InForm input file: Entire Cell Area (pixels), Nucleus Area (pixels), Nucleus Compactness, Nucleus Axis Ratio, and Entire Cell Axis Ratio.</p>
</div>
</div>
<div id="halo-input" class="section level2">
<h2 class="hasAnchor">
<a href="#halo-input" class="anchor"></a>HALO input</h2>
<div id="intensity-columns-1" class="section level4">
<h4 class="hasAnchor">
<a href="#intensity-columns-1" class="anchor"></a>Intensity columns</h4>
<p>For HALO you can also just specify the <code>locations</code> to auto-detect the columns as shown above. But if you want to specify the columns instead, you can do so with <code>intensity_columns_interest</code>, as shown in the example below. Note that then you also must specify the <code>dye_columns_interest</code>.</p>
</div>
<div id="dye-columns" class="section level4">
<h4 class="hasAnchor">
<a href="#dye-columns" class="anchor"></a>Dye columns</h4>
<p><code>format_image_to_sce</code> requires the HALO dye columns to assign the phenotype. If not using <code>locations</code> to auto-detect, these can be specified with <code>dye_columns_interest</code>. These columns have the marker status (1 or 0 for whether the cell is positive or negative for the marker) and these are used to create the phenotype column. For example, if HALO has assigned a cell a marker status of 1 for CD3 and 1 for CD4, SPIAT will give it the Phenotype “CD3,CD4.” Cells that have a marker status of 1 for DAPI and no other marker, are given the phenotype “OTHER.”</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_halo_data</span> <span class="op">&lt;-</span> <span class="st">"path/to/halo/file"</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PDL-1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">intensity_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Dye 1 Nucleus Intensity"</span>,
                                <span class="st">"Dye 2 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 3 Membrane Intensity"</span>,
                                <span class="st">"Dye 4 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 5 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 6 Cytoplasm Intensity"</span><span class="op">)</span>
<span class="va">dye_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Dye 1 Positive Nucleus"</span>,
                          <span class="st">"Dye 2 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 3 Positive Membrane"</span>,
                          <span class="st">"Dye 4 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 5 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 6 Positive Cytoplasm"</span><span class="op">)</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"HALO"</span>,
                          image<span class="op">=</span><span class="va">raw_halo_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                          intensity_columns_interest<span class="op">=</span><span class="va">intensity_columns_interest</span>,
                          dye_columns_interest<span class="op">=</span><span class="va">dye_columns_interest</span>
                          <span class="op">)</span></code></pre></div>
</div>
<div id="x-and-y-location-columns-1" class="section level4">
<h4 class="hasAnchor">
<a href="#x-and-y-location-columns-1" class="anchor"></a>X and Y location columns</h4>
<p><code>format_image_to_sce</code> takes the average of the HALO X min and X max columns for each cell to create the Cell.X.Position column. It takes the average of the Y min and Y max to create the Cell.Y.Position column.</p>
</div>
<div id="phenotype-column-1" class="section level4">
<h4 class="hasAnchor">
<a href="#phenotype-column-1" class="anchor"></a>Phenotype column</h4>
<p><code>format_image_to_sce</code> creates the Phenotype column from the dye columns as described under the Dye columns section above.</p>
</div>
<div id="cell-properties-columns-1" class="section level4">
<h4 class="hasAnchor">
<a href="#cell-properties-columns-1" class="anchor"></a>Cell properties columns</h4>
<p>The following cell properties columns are required to be present in the HALO input file: Cell Area, Nucleus Area, Cytoplasm Area and Membrane Perimeter.</p>
</div>
</div>
<div id="splitting-images" class="section level2">
<h2 class="hasAnchor">
<a href="#splitting-images" class="anchor"></a>Splitting images</h2>
<p>In the case of large images, or images where there are two independent tissue sections, it is recommended to split images into sections defined by the user. This can be performed with <code>image_splitter</code> after <code>format_image_to_sce</code>. It can also plot the different combinations of markers within the image segments.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/image_splitter.html">image_splitter</a></span><span class="op">(</span><span class="va">formatted_image</span>, number_of_splits<span class="op">=</span><span class="fl">3</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="example-data" class="section level2">
<h2 class="hasAnchor">
<a href="#example-data" class="anchor"></a>Example data</h2>
<p>In this vignette we will use an InForm data file that’s already been formatted for SPIAT with <code>format_image_to_sce</code>, which we can load with <code>data</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"formatted_image"</span><span class="op">)</span></code></pre></div>
<p>This is <em>SingleCellExperiment</em> format.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "SingleCellExperiment"
## attr(,"package")
## [1] "SingleCellExperiment"</code></pre>
<p>This example data has 6 markers and 8419 cells.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span></code></pre></div>
<pre><code>## [1]    6 8419</code></pre>
<p><code>assay</code> stores the intensity level of every marker (rows) for every cell (columns).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># take a look at first 5 columns</span>
<span class="fu">assay</span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></code></pre></div>
<pre><code>##       Cell_1 Cell_2 Cell_3 Cell_4 Cell_5
## DAPI  14.557 17.588 21.262 18.951 18.631
## CD3    0.169  0.229  0.206  0.226  0.212
## PDL-1  0.274  0.117  0.103  0.126  0.091
## CD4    1.655  1.188  0.924  1.367  1.266
## CD8    0.096  0.087  0.053  0.037  0.046
## AMACR  0.054  2.074  1.521  2.462  1.968</code></pre>
<p><code>colData</code> stores the phenotype, x and y coordinates, and the cell properties.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># take a look at first 5 rows</span>
<span class="fu">colData</span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></code></pre></div>
<pre><code>## DataFrame with 5 rows and 8 columns
##          Phenotype Cell.X.Position Cell.Y.Position Cell.Area Nucleus.Area
##        &lt;character&gt;       &lt;numeric&gt;       &lt;numeric&gt; &lt;numeric&gt;    &lt;numeric&gt;
## Cell_1       OTHER              82              30       477          160
## Cell_2       AMACR             171              22       464          177
## Cell_3       AMACR             184              38       553          212
## Cell_4       AMACR             201              52       462          239
## Cell_5       AMACR             219              63       876          451
##        Nucleus.Compactness Nucleus.Axis.Ratio Cell.Axis.Ratio
##                  &lt;numeric&gt;          &lt;numeric&gt;       &lt;numeric&gt;
## Cell_1                0.52               2.05            1.48
## Cell_2                0.54               1.84            1.00
## Cell_3                0.51               1.92            1.21
## Cell_4                0.53               1.47            1.09
## Cell_5                0.53               1.19            1.34</code></pre>
<p>We can check what phenotypes are present with <code>print_phenotypes</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/print_phenotypes.html">print_phenotypes</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "OTHER"   "AMACR"   "CD3,CD4" "CD3,CD8" "CD3"     "PDL-1"</code></pre>
<p>The phenotypes in this example data can be interpreted as follows:</p>
<ul>
<li>AMACR = prostate cancer cells<br>
</li>
<li>CD3,CD4 = helper T cells<br>
</li>
<li>CD3,CD8 = cytotoxic T cells</li>
<li>CD3 = T cells that are not helper or cytotoxic</li>
<li>PDL-1 = immune checkpoint cells</li>
<li>OTHER = other cell types</li>
</ul>
<p>AMACR identifies which cells in the image are prostate cancer cells. CD3,CD4, CD3,CD8, CD3 which types of T cells (immune cells) are present, and PDL-1 is used to help determine if the cancer may benefit from immunotherapy treatment.</p>
</div>
</div>
<div id="quality-control" class="section level1">
<h1 class="hasAnchor">
<a href="#quality-control" class="anchor"></a>Quality control</h1>
<div id="cell-proportionspercentages" class="section level2">
<h2 class="hasAnchor">
<a href="#cell-proportionspercentages" class="anchor"></a>Cell proportions/percentages</h2>
<p>We can obtain the number and proportion of each cell phenotype with <code>calculate_cell_proportions</code>. We can use <code>reference_celltypes</code> to specify celltypes to use as the reference. For example, “Total” will calculate the proportion of each phenotype against all cells. “CD3” will calculate the proportion of each CD3-containing phenotype against all CD3 cells. We can exclude any celltypes that are not of interest e.g. “OTHER” with <code>celltypes_to_exclude</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_cell_proportions.html">calculate_cell_proportions</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_celltypes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Total"</span>, <span class="st">"CD3"</span><span class="op">)</span><span class="op">)</span>
<span class="va">p_cells</span></code></pre></div>
<pre><code>##   Cell_type Number_of_celltype Reference Number_of_reference   Proportion
## 1     AMACR               4446     Total                8419 0.5280912222
## 5     OTHER               3299     Total                8419 0.3918517639
## 3   CD3,CD4                513     Total                8419 0.0609336026
## 4   CD3,CD8                138     Total                8419 0.0163914954
## 2       CD3                 19     Total                8419 0.0022568001
## 6     PDL-1                  4     Total                8419 0.0004751158
## 8   CD3,CD4                513       CD3                 670 0.7656716418
## 9   CD3,CD8                138       CD3                 670 0.2059701493
## 7       CD3                 19       CD3                 670 0.0283582090
##    Percentage Proportion_name
## 1 52.80912222     AMACR/Total
## 5 39.18517639     OTHER/Total
## 3  6.09336026   CD3,CD4/Total
## 4  1.63914954   CD3,CD8/Total
## 2  0.22568001       CD3/Total
## 6  0.04751158     PDL-1/Total
## 8 76.56716418     CD3,CD4/CD3
## 9 20.59701493     CD3,CD8/CD3
## 7  2.83582090         CD3/CD3</code></pre>
<p>To visualize the phenotype proportions as barplots we can use <code>plot_cell_percentages</code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_percentages.html">plot_cell_percentages</a></span><span class="op">(</span><span class="va">p_cells</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>We may see incorrect phenotypes present in the input data. For example, cells might be incorrectly assigned a phenotype such as “AMACR,CD3,” both a tumour cell (AMACR) and an immune cell phenotype (CD3), which is biologically implausible. Incorrect cell phenotypes may be present due to low cell segmentation quality, antibody ‘bleeding’ from one cell to another or inadequate marker thresholding.</p>
<p>We can use <code>marker_permutation</code> to help identify if incorrect cell phenotypes are present. This permutes the marker labels of cells to create a null distribution, and then calculates the empirical p-value of whether an image is enriched or depleted in a particular combination of markers. A low P value for Depletion.p suggests the phenotype is unreliable. However, it is not absolute and it is recommended to review the results.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># permute marker labels of cells</span>
<span class="va">sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marker_permutation.html">marker_permutation</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_iter <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>

<span class="co"># sort by Observed_cell_number</span>
<span class="va">sig.sorted</span> <span class="op">&lt;-</span> <span class="va">sig</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">sig</span><span class="op">$</span><span class="va">Observed_cell_number</span><span class="op">)</span>, <span class="op">]</span>

<span class="co"># take a look</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sig.sorted</span><span class="op">)</span></code></pre></div>
<pre><code>##         Percentage_of_occurrence Observed_cell_number
## AMACR                        100                 4446
## CD3,CD4                      100                  512
## CD3,CD8                      100                  138
## CD3                          100                   19
## PDL-1                         83                    4
## CD4                          100                    0
##         Average_bootstrap_cell_number Enrichment.p Depletion.p
## AMACR                         3778.66         0.01        1.00
## CD3,CD4                         18.08         0.01        1.00
## CD3,CD8                          5.20         0.01        1.00
## CD3                            293.64         1.00        0.01
## PDL-1                            1.58         0.01        1.00
## CD4                            216.50         1.00        0.01</code></pre>
<p>If you identify incorrect phenotypes or have any you want to exclude you can do that with <code>select_phenotypes</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_phenotypes.html">select_phenotypes</a></span><span class="op">(</span><span class="va">formatted_image</span>, keep<span class="op">=</span><span class="cn">TRUE</span>,
                                     phenotypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AMACR"</span>,
                                                    <span class="st">"CD3,CD8"</span>,
                                                    <span class="st">"PDL-1"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/print_phenotypes.html">print_phenotypes</a></span><span class="op">(</span><span class="va">data_subset</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "AMACR"   "CD3,CD8" "PDL-1"</code></pre>
<p>In this vignette we will work with all the original phenotypes present in <code>formatted_image</code>.</p>
</div>
<div id="boxplots-of-marker-positive-and-negative-cells" class="section level2">
<h2 class="hasAnchor">
<a href="#boxplots-of-marker-positive-and-negative-cells" class="anchor"></a>Boxplots of marker positive and negative cells</h2>
<p>Incorrect or unreliable phenotyping of cells may also be identified through comparing the marker level for cells labelled positive and negative for a marker. Cells positive for a marker should have high levels of the marker. An unclear separation of marker intensities between positive and negative cells would suggest phenotypes have not been accurately assigned. We can use <code>marker_intensity_boxplot</code> to produce a boxplot for cells phenotyped as being positive or negative for a marker.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_intensity_boxplot.html">marker_intensity_boxplot</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="st">"CD3"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>Note that some negative cells will have high marker intensity, and vice versa. This is because HALO and InForm use machine learning to determine positive cells, and not a strict threshold, and also take into account properties such as cell shape, nucleus size etc.</p>
</div>
<div id="predict-cell-phenotypes" class="section level2">
<h2 class="hasAnchor">
<a href="#predict-cell-phenotypes" class="anchor"></a>Predict cell phenotypes</h2>
<p>SPIAT can predict cell phenotypes using the marker intensity levels with <code>predict_phenotypes</code>. This can be used to check the phenotypes that have been assigned by InForm and HALO. It can also potentially be used to automate the manual phenotypying performed with InForm/HALO. <code>predict_phenotypes</code> produces a density plot that shows the cutoff for calling a cell positive for a marker. It also prints to the console the number of true positives (TP), true negatives (TN), false positives (FP) and false negatives (FN). It returns a table containing the phenotypes predicted by SPIAT and the actual phenotypes from InForm/HALO. This can help show if we need to go back to Inform or HALO to refine the phenotyping. If you don’t have a <code>tumour_marker</code> you can use a marker that is present in many cells, that has at least one peak more than the main marker peak, a background peak, required by the algorithm. Of note, this algorithm does not take into account cell shape or size, so if these are required for phenotyping, manual phenotyping with HALO or InForm is recommended.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_phenotypes.html">predict_phenotypes</a></span><span class="op">(</span><span class="va">formatted_image</span>,
                                      thresholds <span class="op">=</span> <span class="cn">NULL</span>,
                                      tumour_marker <span class="op">=</span> <span class="st">"AMACR"</span>,
                                      baseline_markers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD3"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "For CD3:"
## [1] "TP:660 TN:6646 FP:1098 FN:9"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<pre><code>## [1] "For PDL-1:"
## [1] "TP:2 TN:8182 FP:227 FN:2"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-2.png" width="700"></p>
<pre><code>## [1] "For CD4:"
## [1] "TP:410 TN:7472 FP:429 FN:102"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-3.png" width="700"></p>
<pre><code>## [1] "For CD8:"
## [1] "TP:138 TN:7639 FP:636 FN:0"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-4.png" width="700"></p>
<pre><code>## [1] "For AMACR:"
## [1] "TP:4359 TN:3950 FP:17 FN:87"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-5.png" width="700"></p>
<p>We can use <code>marker_prediction_plot</code> to plot the predicted cell phenotypes and the ones obtained using HALO or InForm, for comparison.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_prediction_plot.html">marker_prediction_plot</a></span><span class="op">(</span><span class="va">predicted_image</span>, marker<span class="op">=</span><span class="st">"CD3"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>The plot shows CD3+ cells in the tissue. On the left are the CD3+ cells defined by InForm and on the right are the CD3+ cells predicted using SPIAT.</p>
</div>
<div id="scatter-plots-of-marker-level" class="section level2">
<h2 class="hasAnchor">
<a href="#scatter-plots-of-marker-level" class="anchor"></a>Scatter plots of marker level</h2>
<p>Uneven marker staining or high background intensity can be identified with <code>plot_cell_marker_levels</code>. This produces a scatter plot of the intensity of a marker in each cell. Cells that were not phenotyped as being positive for the particular marker are excluded.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_marker_levels.html">plot_cell_marker_levels</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="st">"CD3"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
<div id="heatmaps-of-marker-level" class="section level2">
<h2 class="hasAnchor">
<a href="#heatmaps-of-marker-level" class="anchor"></a>Heatmaps of marker level</h2>
<p>For large images, there is also the option of ‘blurring’ the image, where the image is split into multiple small areas, and marker intensities are averaged within each. The image is blurred based on the <code>num_splits</code> parameter.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_marker_level_heatmap.html">plot_marker_level_heatmap</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits <span class="op">=</span> <span class="fl">100</span>, <span class="st">"AMACR"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
</div>
<div id="visualizing-tissues" class="section level1">
<h1 class="hasAnchor">
<a href="#visualizing-tissues" class="anchor"></a>Visualizing tissues</h1>
<p>In addition to the marker level tissue plots for QC, SPIAT has other methods for visualizing markers and phenotypes in tissues.</p>
<div id="d-surface-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#d-surface-plot" class="anchor"></a>3D surface plot</h2>
<p>We can visualize a selected marker in 3D with <code>marker_surface_plot</code>. The image is blurred based on the <code>num_splits</code> parameter.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_surface_plot.html">marker_surface_plot</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits<span class="op">=</span><span class="fl">15</span>, marker<span class="op">=</span><span class="st">"CD3"</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-58c9e62ce78458ab7c75" style="width:700px;height:432.632880098888px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-58c9e62ce78458ab7c75">{"x":{"visdat":{"d776fd1ab76":["function () ","plotlyVisDat"]},"cur_data":"d776fd1ab76","attrs":{"d776fd1ab76":{"z":{},"reversescale":true,"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"surface","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"zaxis":{"title":"mean_marker_level"}},"hovermode":"closest","showlegend":false,"legend":{"yanchor":"top","y":0.5}},"source":"A","config":{"showSendToCloud":false},"data":[{"colorbar":{"title":"mean_marker_level","ticklen":2,"len":0.5,"lenmode":"fraction","y":1,"yanchor":"top"},"colorscale":[["0","rgba(68,1,84,1)"],["0.0416666666666667","rgba(70,19,97,1)"],["0.0833333333333333","rgba(72,32,111,1)"],["0.125","rgba(71,45,122,1)"],["0.166666666666667","rgba(68,58,128,1)"],["0.208333333333333","rgba(64,70,135,1)"],["0.25","rgba(60,82,138,1)"],["0.291666666666667","rgba(56,93,140,1)"],["0.333333333333333","rgba(49,104,142,1)"],["0.375","rgba(46,114,142,1)"],["0.416666666666667","rgba(42,123,142,1)"],["0.458333333333333","rgba(38,133,141,1)"],["0.5","rgba(37,144,140,1)"],["0.541666666666667","rgba(33,154,138,1)"],["0.583333333333333","rgba(39,164,133,1)"],["0.625","rgba(47,174,127,1)"],["0.666666666666667","rgba(53,183,121,1)"],["0.708333333333333","rgba(79,191,110,1)"],["0.75","rgba(98,199,98,1)"],["0.791666666666667","rgba(119,207,85,1)"],["0.833333333333333","rgba(147,214,70,1)"],["0.875","rgba(172,220,52,1)"],["0.916666666666667","rgba(199,225,42,1)"],["0.958333333333333","rgba(226,228,40,1)"],["1","rgba(253,231,37,1)"]],"showscale":true,"z":[[0.9411875,0.408727272727273,0.183475,0.511133333333333,0.458379310344828,0.501605263157895,1.2934,0.756333333333333,0.32765,0.217086956521739,0.740022727272727,0.504775,0.58974358974359,0.234714285714286,0.172826086956522],[1.18358974358974,0.700864864864865,0.349216216216216,0.387121212121212,0.159290909090909,0.162783783783784,1.20866666666667,0.5851875,0.358962962962963,0.594,0.20904,1.03110344827586,0.229054054054054,0.181452380952381,0.245095238095238],[0.161926829268293,0.357555555555556,1.02061904761905,0.159888888888889,0.140973684210526,0.218162790697674,0.309871794871795,2.24730434782609,1.35286956521739,0.193514285714286,0.216869565217391,0.327714285714286,0.902933333333333,0.325515151515152,0.2485],[0.149727272727273,0.50224,0.682184210526316,0.153466666666667,0.149261904761905,0.808951219512195,0.201685185185185,1.17592682926829,0.717794871794872,0.156111111111111,0.165648648648649,0.178153846153846,1.23357894736842,0.753575757575758,0.755225806451613],[0.13625,0.21390243902439,0.456533333333333,0.298421052631579,0.875931818181818,1.29245945945946,1.307825,2.26726666666667,0.358333333333333,0.140720930232558,0.135564102564103,0.196979591836735,2.24017391304348,1.97705405405405,0.627861111111111],[0.1395,0.166648648648649,0.352121212121212,0.854513513513514,0.392060606060606,1.56603225806452,0.8746,0.800605263157895,0.141488372093023,0.138344827586207,0.138697674418605,0.33463829787234,3.31132608695652,3.83395555555556,0.653866666666667],[0.127341463414634,0.137538461538462,0.152382352941176,0.583103448275862,0.684657894736842,0.448391304347826,0.648451612903226,0.2236,0.153414634146341,0.1640625,0.160575,0.907951219512195,5.27973469387755,2.726725,0.514565217391304],[0.128622222222222,0.217078947368421,0.244290322580645,0.457735294117647,3.2687027027027,0.783794117647059,0.146327272727273,0.129311111111111,0.1595,0.191108108108108,0.819775510204082,2.37678048780488,6.07279661016949,1.25027272727273,0.411238095238095],[0.126384615384615,0.151,0.619678571428571,0.520095238095238,0.580344827586207,0.669606060606061,0.321775510204082,0.129234042553191,0.147630434782609,0.167190476190476,0.219090909090909,4.18034042553191,3.35632558139535,0.356666666666667,0.510634146341463],[0.11076,0.168,0.319,1.096625,0.616820512820513,0.391264705882353,0.423264705882353,0.17125641025641,0.169565217391304,0.2850625,1.28577777777778,2.8230612244898,1.01486666666667,1.53355172413793,0.55259375],[0.181266666666667,0.25996875,0.198,0.488888888888889,0.585486486486486,0.239461538461538,0.483666666666667,0.7629375,1.03295238095238,0.990771428571429,1.60521875,0.523782608695652,1.24916666666667,1.08309090909091,0.5485],[0.1588,0.149588235294118,0.156448275862069,0.205060606060606,0.66247619047619,0.5725625,1.33069444444444,0.841076923076923,0.791942857142857,0.532106382978723,0.774409090909091,1.19012,0.978947368421053,1.27245161290323,1.02511538461538],[0.19224,0.10153125,0.377096774193548,0.166028571428571,0.126454545454545,0.240142857142857,0.514829268292683,0.142536585365854,0.171545454545455,0.38884,0.192111111111111,0.697,0.500722222222222,0.693428571428571,2.50727027027027],[0.0850909090909091,0.267740740740741,0.14815625,0.167326530612245,0.122666666666667,0.180235294117647,0.133690476190476,0.12068085106383,0.135836734693878,0.143073170731707,0.242039215686275,0.85228,1.62090625,1.26369696969697,2.92180769230769],[0.19352,0.117242424242424,0.126078947368421,0.218634146341463,0.125,0.110060606060606,0.106581395348837,0.108684210526316,0.148214285714286,0.181454545454545,0.476435897435897,0.500242424242424,1.26764150943396,2.52873469387755,0.915725]],"reversescale":true,"type":"surface","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<div id="d-stacked-surface-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#d-stacked-surface-plot" class="anchor"></a>3D stacked surface plot</h2>
<p>To visualize multiple markers in 3D in a single plot we can use <code>marker_surface_plot_stack</code>. This shows normalized intensity level of specified markers and enables the identification of co-occurring and mutually exclusive markers.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_surface_plot_stack.html">marker_surface_plot_stack</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits<span class="op">=</span><span class="fl">15</span>, markers<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AMACR"</span>, <span class="st">"CD3"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-230d2b44d71d975e2540" style="width:700px;height:432.632880098888px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-230d2b44d71d975e2540">{"x":{"visdat":{"d776a60f047":["function () ","plotlyVisDat"]},"cur_data":"d776a60f047","attrs":{"d776a60f047":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"z":[[0.0697156244762667,0.608614550939461,0.70689939665928,0.144950485093387,0.273876631077955,0.367178000213659,0.242765088173405,0.438970298504683,0.617497486080334,0.714675947253836,0.733719763132902,0.351292610938344,0.575138150987018,0.662189238295642,0.865244360278288],[0.282728584054444,0.127304519468911,0.578124057280125,0.727873596394853,0.692621589914527,0.741105379788086,0.167947509930341,0.0156204958939312,0.0130910038919201,0.0164089226561061,0.0738079067428912,0.0329114015086086,1,0.921705102591864,0.549922560633348],[0.721343218843633,0.0142910125820127,0.274739815965119,0.730910938964513,0.649152784570316,0.661497559917251,0.707945590470311,0.365999005767037,0.0650302358550525,0.828920791578768,0.931389278638646,0.883431141213119,0.252557159084561,0.289986406212175,0.00799791437775833],[0.721369434461183,0.184000536302862,0.21846600915988,0.7156038807471,0.645017384619068,0.563992040844041,0.701912834232344,0.502236112240268,0.478791542343431,0.676940863919356,0.73208431872777,0.783514072936616,0.520628862149975,0.00669708199102437,0.00411355348101285],[0.713646603415206,0.682113563766129,0.0206548481406305,0.605222494141538,0.597039347498184,0.310232956555744,0.597898186253515,0.190060706504534,0.602623694158395,0.601630492351491,0.594388816710189,0.794056143825847,0.161484572791536,0.0033693972179289,0.00338988100780246],[0.666344155602316,0.854360253998994,0.0154336045883689,0.0283678143796205,0.0184514254855589,0.280404858202316,0.0145764883335506,0.62345996693191,0.549969897923169,0.542628050977025,0.599652901531001,0.778341248845558,0.00573607648792873,0.00284419284557085,0.00223787266531349],[0.634465670576148,0.638061359693918,0.0149367138524094,0.140433922440281,0.399787654645263,0.777113744946859,0.327536472859579,0.71303611478371,0.667506423325904,0.637079733152083,0.6470442263645,0.508580291687351,0.00478503611645585,0.00495115547196514,0.0035414610528668],[0.66531972713109,0.674869535900047,0.0118441357792941,0.242627774485523,0.0101782089719,0.0978465402659826,0.627519338559803,0.591308243794343,0.648226550716002,0.686536563564924,0.60961725715593,0.166360611897585,0.00193830938981346,0.00263198078248077,0.00624824757187283],[0.667240518368803,0.79593303662874,0.0096479714397444,0.151353659282748,0.0266861658647595,0.0240461071488427,0.74384912073617,0.626680576097675,0.632971007745787,0.720980641488453,0.817691663097521,0.0899130607734631,0.00014677306689105,0.00205092394306748,0.00274289301057663],[0.551648840803709,0.803662016600964,0.00968045287797247,0.0140004841623061,0.0128811238295233,0.618443746802831,0.467924762053944,0.73404067822831,0.704948462622751,0.687508519394425,0.596199226581752,0.00187098708685165,0.00420841325114988,0.00104823065646373,0.00241882134410905],[0.144541218971714,0.0877678604681477,0.00503560721135813,0.00659832529499761,0.0168149568909331,0.158980967264612,0.406127233597672,0.0156299696467477,0.00733096217947524,0.0111421175982357,0.00986519105789464,0.00431254215167234,0.00229092568108601,0,0.00144460376281013],[0.0716433436993724,0.00434394364438388,0.00681872616511989,0.367554049272825,0.386887395020577,0.00831623247239344,0.00875834093716442,0.0111904233268826,0.333734769504159,0.671012901617982,0.737368019217519,0.0264785534720024,0.00421160440999334,0.00395219407820242,0.00460835137005041],[0.0659499972067559,0.00852939191076516,0.0119174809623897,0.78083527042593,0.702421928828141,0.239724825555257,0.576691490961017,0.693537523260002,0.831643917245489,0.712017496880877,0.91686175924719,0.483483773212103,0.00586568841051998,0.00337905386172644,0.054177389620305],[0.0613072382264762,0.634249186338347,0.127046039645444,0.799921363528745,0.706721290106329,0.566857490878141,0.804739443532576,0.66414342297996,0.648919797411898,0.583390589538006,0.780763683883639,0.0207306381631627,0.00580095109960708,0.00879164261373159,0.202446545186811],[0.373354328597233,0.747193162138508,0.486188280331935,0.728408327773339,0.737910878852594,0.649382693059719,0.629792654677514,0.635558447897177,0.690144929463936,0.746768738012327,0.523402715606213,0.00217724064728776,0.00397904118295819,0.00747635528392471,0.184789510437422]],"type":"surface","colorscale":[[0,1],["rgb(255,255,255)","rgb(230,159,0)"]],"colorbar":{"title":"AMACR"},"inherit":true},"d776a60f047.1":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"z":[[1.14297572954444,1.05405014538007,1.01643101645616,1.07115286647533,1.06234247638234,1.06956159418322,1.201798343344,1.11210344291329,1.0405095211786,1.02204451154088,1.10937942692538,1.07009096837099,1.08428147705419,1.02498843197928,1.01465255345629],[1.18345905582851,1.10283971633125,1.04411127071221,1.0504417414797,1.01239205861214,1.01297539968921,1.18764712456949,1.08352056962636,1.04573906393274,1.08499233534765,1.02070059837556,1.15799249101614,1.02404312305082,1.01609322112209,1.02672214317005],[1.01283228067865,1.04550401440331,1.15624150304508,1.01249192654617,1.00933291947023,1.02222418539755,1.03754040311975,1.36110883645228,1.21173028859754,1.0181076662809,1.02200820526345,1.0405202574635,1.13658694416045,1.04015298253235,1.0272907686294],[1.01079484645091,1.06966760086989,1.09971988124397,1.0114193584303,1.01071712587,1.12089109695069,1.01947227901887,1.18217928111946,1.10566717776226,1.01186100412507,1.01345385755069,1.01554233653237,1.19180769657243,1.11164290328505,1.11191847609344],[1.00854402227883,1.02151266885249,1.06203418183621,1.03562802752684,1.13207745145999,1.20164126472533,1.20420744638282,1.36444272088768,1.04563391019589,1.00929070731242,1.00842947131889,1.01868640316201,1.3599179905526,1.31597463860362,1.09064744146033],[1.0090868011264,1.01362086642686,1.04459643081359,1.12850040446778,1.0512666641105,1.24733035037224,1.13185502600218,1.11949724815936,1.00941887691507,1.00889387707978,1.00895280563272,1.04167662895264,1.53880991132955,1.62609367153589,1.09499060006795],[1.00705621759535,1.00875920679236,1.01123826841358,1.08317251449002,1.10013300846398,1.06067439072556,1.0940862380245,1.02313224761266,1.01141066853755,1.01318895664743,1.01260651319177,1.13742497569195,1.86755162062339,1.44117634078663,1.07172602157501],[1.00727011568446,1.02204317394119,1.02658771513454,1.062234919956,1.53169142782657,1.11668963764039,1.01022701627191,1.0073851662436,1.01242697864988,1.01770581326302,1.12269884957453,1.38273250108153,2,1.19459570599335,1.05446947502587],[1.00689641548119,1.0110074032024,1.0892808847037,1.072649584118,1.08271180034885,1.09761921856144,1.03952842923969,1.00737229511035,1.01044465590225,1.0137113564357,1.02237918940737,1.68394301939444,1.5463252263242,1.04535556206893,1.07106949781682],[1.00428696602515,1.01384655409737,1.0390648943997,1.16893517173479,1.08880356354752,1.05113374171618,1.05647802575376,1.01439040351465,1.01410795929486,1.03339703066453,1.20052536457672,1.45726534537355,1.1552808043669,1.24190581290361,1.07807712406855],[1.01606220518795,1.02920615167803,1.0188568203826,1.06743784680754,1.08357050302346,1.02578126532552,1.06656568934308,1.11320639736635,1.15830127918457,1.15125668573146,1.2538748423516,1.07326540773801,1.19441098405456,1.16667485842202,1.07739343148171],[1.01231007243656,1.01077162596545,1.01191731363121,1.02003600426589,1.09642846696378,1.08141208256466,1.20802684659822,1.12625637459935,1.11805054946582,1.07465555192656,1.11512225487201,1.18454966661271,1.14928196273393,1.1982997767573,1.15699243123374],[1.01789484925583,1.00274568285915,1.04876757136712,1.01351730802719,1.00690809442358,1.0258950515928,1.07177012041931,1.00959393783576,1.01443867647653,1.05072879431171,1.01787332366735,1.10219424959361,1.06941411850894,1.10159778932156,1.40452545300332],[1,1.03050414311728,1.01053247171078,1.01373407873178,1.00627548504413,1.01588995681762,1.00811655908386,1.00594383621201,1.00847500330449,1.00968355235468,1.02621176030196,1.12812738788596,1.25649479409658,1.19683767363412,1.47375688199001],[1.01810862061734,1.00536958841276,1.00684536620932,1.0223029059739,1.00666517242187,1.00417016102932,1.00358910195838,1.00394029075797,1.0105421641902,1.01609358261317,1.06535808669997,1.06933398798754,1.19749644678262,1.4081102022677,1.13872326603485]],"type":"surface","colorscale":[[0,1],["rgb(255,255,255)","rgb(86,180,233)"]],"colorbar":{"title":"CD3"},"inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"zaxis":{"title":[]}},"hovermode":"closest","showlegend":false,"legend":{"yanchor":"top","y":0.333333333333333}},"source":"A","config":{"showSendToCloud":false},"data":[{"colorbar":{"title":"AMACR","ticklen":2,"len":0.333333333333333,"lenmode":"fraction","y":1,"yanchor":"top"},"colorscale":[[0,"rgb(255,255,255)"],[1,"rgb(230,159,0)"]],"showscale":true,"z":[[0.0697156244762667,0.608614550939461,0.70689939665928,0.144950485093387,0.273876631077955,0.367178000213659,0.242765088173405,0.438970298504683,0.617497486080334,0.714675947253836,0.733719763132902,0.351292610938344,0.575138150987018,0.662189238295642,0.865244360278288],[0.282728584054444,0.127304519468911,0.578124057280125,0.727873596394853,0.692621589914527,0.741105379788086,0.167947509930341,0.0156204958939312,0.0130910038919201,0.0164089226561061,0.0738079067428912,0.0329114015086086,1,0.921705102591864,0.549922560633348],[0.721343218843633,0.0142910125820127,0.274739815965119,0.730910938964513,0.649152784570316,0.661497559917251,0.707945590470311,0.365999005767037,0.0650302358550525,0.828920791578768,0.931389278638646,0.883431141213119,0.252557159084561,0.289986406212175,0.00799791437775833],[0.721369434461183,0.184000536302862,0.21846600915988,0.7156038807471,0.645017384619068,0.563992040844041,0.701912834232344,0.502236112240268,0.478791542343431,0.676940863919356,0.73208431872777,0.783514072936616,0.520628862149975,0.00669708199102437,0.00411355348101285],[0.713646603415206,0.682113563766129,0.0206548481406305,0.605222494141538,0.597039347498184,0.310232956555744,0.597898186253515,0.190060706504534,0.602623694158395,0.601630492351491,0.594388816710189,0.794056143825847,0.161484572791536,0.0033693972179289,0.00338988100780246],[0.666344155602316,0.854360253998994,0.0154336045883689,0.0283678143796205,0.0184514254855589,0.280404858202316,0.0145764883335506,0.62345996693191,0.549969897923169,0.542628050977025,0.599652901531001,0.778341248845558,0.00573607648792873,0.00284419284557085,0.00223787266531349],[0.634465670576148,0.638061359693918,0.0149367138524094,0.140433922440281,0.399787654645263,0.777113744946859,0.327536472859579,0.71303611478371,0.667506423325904,0.637079733152083,0.6470442263645,0.508580291687351,0.00478503611645585,0.00495115547196514,0.0035414610528668],[0.66531972713109,0.674869535900047,0.0118441357792941,0.242627774485523,0.0101782089719,0.0978465402659826,0.627519338559803,0.591308243794343,0.648226550716002,0.686536563564924,0.60961725715593,0.166360611897585,0.00193830938981346,0.00263198078248077,0.00624824757187283],[0.667240518368803,0.79593303662874,0.0096479714397444,0.151353659282748,0.0266861658647595,0.0240461071488427,0.74384912073617,0.626680576097675,0.632971007745787,0.720980641488453,0.817691663097521,0.0899130607734631,0.00014677306689105,0.00205092394306748,0.00274289301057663],[0.551648840803709,0.803662016600964,0.00968045287797247,0.0140004841623061,0.0128811238295233,0.618443746802831,0.467924762053944,0.73404067822831,0.704948462622751,0.687508519394425,0.596199226581752,0.00187098708685165,0.00420841325114988,0.00104823065646373,0.00241882134410905],[0.144541218971714,0.0877678604681477,0.00503560721135813,0.00659832529499761,0.0168149568909331,0.158980967264612,0.406127233597672,0.0156299696467477,0.00733096217947524,0.0111421175982357,0.00986519105789464,0.00431254215167234,0.00229092568108601,0,0.00144460376281013],[0.0716433436993724,0.00434394364438388,0.00681872616511989,0.367554049272825,0.386887395020577,0.00831623247239344,0.00875834093716442,0.0111904233268826,0.333734769504159,0.671012901617982,0.737368019217519,0.0264785534720024,0.00421160440999334,0.00395219407820242,0.00460835137005041],[0.0659499972067559,0.00852939191076516,0.0119174809623897,0.78083527042593,0.702421928828141,0.239724825555257,0.576691490961017,0.693537523260002,0.831643917245489,0.712017496880877,0.91686175924719,0.483483773212103,0.00586568841051998,0.00337905386172644,0.054177389620305],[0.0613072382264762,0.634249186338347,0.127046039645444,0.799921363528745,0.706721290106329,0.566857490878141,0.804739443532576,0.66414342297996,0.648919797411898,0.583390589538006,0.780763683883639,0.0207306381631627,0.00580095109960708,0.00879164261373159,0.202446545186811],[0.373354328597233,0.747193162138508,0.486188280331935,0.728408327773339,0.737910878852594,0.649382693059719,0.629792654677514,0.635558447897177,0.690144929463936,0.746768738012327,0.523402715606213,0.00217724064728776,0.00397904118295819,0.00747635528392471,0.184789510437422]],"type":"surface","frame":null},{"colorbar":{"title":"CD3","ticklen":2,"len":0.333333333333333,"lenmode":"fraction","y":0.666666666666667,"yanchor":"top"},"colorscale":[[0,"rgb(255,255,255)"],[1,"rgb(86,180,233)"]],"showscale":true,"z":[[1.14297572954444,1.05405014538007,1.01643101645616,1.07115286647533,1.06234247638234,1.06956159418322,1.201798343344,1.11210344291329,1.0405095211786,1.02204451154088,1.10937942692538,1.07009096837099,1.08428147705419,1.02498843197928,1.01465255345629],[1.18345905582851,1.10283971633125,1.04411127071221,1.0504417414797,1.01239205861214,1.01297539968921,1.18764712456949,1.08352056962636,1.04573906393274,1.08499233534765,1.02070059837556,1.15799249101614,1.02404312305082,1.01609322112209,1.02672214317005],[1.01283228067865,1.04550401440331,1.15624150304508,1.01249192654617,1.00933291947023,1.02222418539755,1.03754040311975,1.36110883645228,1.21173028859754,1.0181076662809,1.02200820526345,1.0405202574635,1.13658694416045,1.04015298253235,1.0272907686294],[1.01079484645091,1.06966760086989,1.09971988124397,1.0114193584303,1.01071712587,1.12089109695069,1.01947227901887,1.18217928111946,1.10566717776226,1.01186100412507,1.01345385755069,1.01554233653237,1.19180769657243,1.11164290328505,1.11191847609344],[1.00854402227883,1.02151266885249,1.06203418183621,1.03562802752684,1.13207745145999,1.20164126472533,1.20420744638282,1.36444272088768,1.04563391019589,1.00929070731242,1.00842947131889,1.01868640316201,1.3599179905526,1.31597463860362,1.09064744146033],[1.0090868011264,1.01362086642686,1.04459643081359,1.12850040446778,1.0512666641105,1.24733035037224,1.13185502600218,1.11949724815936,1.00941887691507,1.00889387707978,1.00895280563272,1.04167662895264,1.53880991132955,1.62609367153589,1.09499060006795],[1.00705621759535,1.00875920679236,1.01123826841358,1.08317251449002,1.10013300846398,1.06067439072556,1.0940862380245,1.02313224761266,1.01141066853755,1.01318895664743,1.01260651319177,1.13742497569195,1.86755162062339,1.44117634078663,1.07172602157501],[1.00727011568446,1.02204317394119,1.02658771513454,1.062234919956,1.53169142782657,1.11668963764039,1.01022701627191,1.0073851662436,1.01242697864988,1.01770581326302,1.12269884957453,1.38273250108153,2,1.19459570599335,1.05446947502587],[1.00689641548119,1.0110074032024,1.0892808847037,1.072649584118,1.08271180034885,1.09761921856144,1.03952842923969,1.00737229511035,1.01044465590225,1.0137113564357,1.02237918940737,1.68394301939444,1.5463252263242,1.04535556206893,1.07106949781682],[1.00428696602515,1.01384655409737,1.0390648943997,1.16893517173479,1.08880356354752,1.05113374171618,1.05647802575376,1.01439040351465,1.01410795929486,1.03339703066453,1.20052536457672,1.45726534537355,1.1552808043669,1.24190581290361,1.07807712406855],[1.01606220518795,1.02920615167803,1.0188568203826,1.06743784680754,1.08357050302346,1.02578126532552,1.06656568934308,1.11320639736635,1.15830127918457,1.15125668573146,1.2538748423516,1.07326540773801,1.19441098405456,1.16667485842202,1.07739343148171],[1.01231007243656,1.01077162596545,1.01191731363121,1.02003600426589,1.09642846696378,1.08141208256466,1.20802684659822,1.12625637459935,1.11805054946582,1.07465555192656,1.11512225487201,1.18454966661271,1.14928196273393,1.1982997767573,1.15699243123374],[1.01789484925583,1.00274568285915,1.04876757136712,1.01351730802719,1.00690809442358,1.0258950515928,1.07177012041931,1.00959393783576,1.01443867647653,1.05072879431171,1.01787332366735,1.10219424959361,1.06941411850894,1.10159778932156,1.40452545300332],[1,1.03050414311728,1.01053247171078,1.01373407873178,1.00627548504413,1.01588995681762,1.00811655908386,1.00594383621201,1.00847500330449,1.00968355235468,1.02621176030196,1.12812738788596,1.25649479409658,1.19683767363412,1.47375688199001],[1.01810862061734,1.00536958841276,1.00684536620932,1.0223029059739,1.00666517242187,1.00417016102932,1.00358910195838,1.00394029075797,1.0105421641902,1.01609358261317,1.06535808669997,1.06933398798754,1.19749644678262,1.4081102022677,1.13872326603485]],"type":"surface","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script><p>The stacked surface plots of the AMACR (tumour cell) and CD3 (T cell) markers in this prostate tissue shows how AMACR and CD3 are mutually exclusive as the peaks and valleys are opposite.</p>
</div>
<div id="categorical-dot-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#categorical-dot-plot" class="anchor"></a>Categorical dot plot</h2>
<p>We can see the location of all phenotypes in the tissue with <code>plot_cell_categories</code>. Each dot in the plot corresponds to a cell and cells are coloured by phenotype. We can choose the colours for the phenotypes. Any phenotypes present in the data but not in the phenotypes of interest will be put in the category “OTHER” and coloured lightgrey.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">phenotypes_of_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AMACR"</span>, <span class="st">"CD3,CD8"</span>, <span class="st">"CD3,CD4"</span>, <span class="st">"PDL-1"</span><span class="op">)</span>
<span class="va">colour_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkgrey"</span>, <span class="st">"darkcyan"</span>, <span class="st">"skyBlue"</span>, <span class="st">"orange"</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot_cell_categories.html">plot_cell_categories</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="va">phenotypes_of_interest</span>, <span class="va">colour_vector</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
</div>
</div>
<div id="gradients-of-cells" class="section level1">
<h1 class="hasAnchor">
<a href="#gradients-of-cells" class="anchor"></a>Gradients of cells</h1>
<p>To determine whether two cell types are interacting with another, or if there is repulsion between them, SPIAT uses the concept of gradients. The assumption is that, if marker A intensity is high close to cells of marker B, and this value decreases as the distance from B increases, it suggests the cells are close and interacting. Conversely, if we see that marker A intensity is low when close to cells of marker B but increases with distance, it suggests there is repulsion between the two cell types.</p>
<p><code>plot_average_intensity</code> calculates the average intensity of a target marker for a number of user-supplied radii values. It plots the intensity level at each specified radius as a line graph. The radius unit is pixels.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_average_intensity.html">plot_average_intensity</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_marker<span class="op">=</span><span class="st">"CD8"</span>, target_marker<span class="op">=</span><span class="st">"CD4"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">35</span>, <span class="fl">40</span>, <span class="fl">45</span>, <span class="fl">50</span>, <span class="fl">75</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<p>This plot shows that high levels of CD8 were observed in cells near CD4 cells and these levels decreased at larger radii. This suggests CD4 and CD8 cells may be closely interacting in this tissue.</p>
<p>We can use <code>average_marker_intensity_within_radius</code> to calculate the average intensity of the target_marker within a radius from the cells positive for the reference marker. Note that it pools all cells with the target marker that are within the specific radius of any reference cell. Results represent the average intensities within a radius, but do not correspond to metrics for each cell. This function can also be used to help identify radii values for <code>plot_average_intensity</code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_marker_intensity_within_radius.html">average_marker_intensity_within_radius</a></span><span class="op">(</span><span class="va">formatted_image</span>,
                                        reference_marker <span class="op">=</span><span class="st">"CD8"</span>,
                                        target_marker <span class="op">=</span> <span class="st">"CD4"</span>,
                                        radius<span class="op">=</span><span class="fl">30</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 10.13677</code></pre>
</div>
<div id="neighbourhood-proportions" class="section level1">
<h1 class="hasAnchor">
<a href="#neighbourhood-proportions" class="anchor"></a>Neighbourhood proportions</h1>
<p>We can characterise cell aggregation in another way, through calculation of the neighbourhood proportion with <code>percentage_of_cells_within_radius</code>. Here, we define the proportion of a target cell type within the neighbourhood of a reference cell type within a defined radius. Cells with high neighbourhood proportions of the target cell type can indicate spatial sturctures. <code>percentage_of_cells_within_radius</code> can be used for the detection of gradients instead of <code>average_marker_intensity_within_radius</code>, however we recommend using the latter as it is faster, and it uses marker intensities so does not depend on cell phenotyping. The calculation is performed for each reference cell, so runtime will depend on the number of reference cells present.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_cells_within_radius</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/percentage_of_cells_within_radius.html">percentage_of_cells_within_radius</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_phenotypes <span class="op">=</span> <span class="st">"PDL-1"</span>, target_phenotypes <span class="op">=</span> <span class="st">"AMACR"</span>, radius<span class="op">=</span><span class="fl">100</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_cells_within_radius</span></code></pre></div>
<pre><code>##  Cell_664 Cell_2760 Cell_2992 Cell_3147 
##  5.357143 36.734694  0.000000  0.000000</code></pre>
</div>
<div id="distances-between-phenotypes" class="section level1">
<h1 class="hasAnchor">
<a href="#distances-between-phenotypes" class="anchor"></a>Distances between phenotypes</h1>
<p>We can calculate the distances between two phenotypes (phenotype A and phenotype B) by identifying the closest cell of phenotype B to each of the cells of phenotype A with <code>calculate_all_distances_between_phenotypes</code>.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_all_distances_between_phenotypes.html">calculate_all_distances_between_phenotypes</a></span><span class="op">(</span><span class="va">formatted_image</span>, remove_other <span class="op">=</span> <span class="cn">TRUE</span>, cell_phenotypes_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This creates a distribution of minimum distances between phenotypes A and B, which can be visualized as a violin plot with <code>plot_cell_distances_violin</code>. Visualization of this distribution often reveals whether pairs of cells are evenly spaced across the image, or whether there are clusters of pairs of phenotypes.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_distances_violin.html">plot_cell_distances_violin</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
<p>From this plot we can see that CD3,CD4 cells seem to be more closely interacting with each other, as there are shorter distances between those cells, than between CD3,CD8 cells or between CD3,CD4 and CD3,CD8 cells.</p>
<p>We can also calculate summary statistics for the distances between each combination of phenotypes, the mean, median and standard deviation, with <code>calculate_summary_distances_between_phenotypes</code>.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">summary_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_summary_distances_between_phenotypes.html">calculate_summary_distances_between_phenotypes</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "All markers are used in pair-wise distance calculation: "
## [1] "OTHER"   "AMACR"   "CD3,CD4" "CD3,CD8" "CD3"     "PDL-1"</code></pre>
<p>These cell distances can then be visualized as a heatmap with <code>plot_distance_heatmap</code>.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_distance_heatmap.html">plot_distance_heatmap</a></span><span class="op">(</span><span class="va">summary_distances</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<p>This plot shows that AMACR cells are interacting most closely with CD3,CD4, followed by CD3,CD8, while PDL-1 cells are more distant.</p>
</div>
<div id="cell-mixing-score" class="section level1">
<h1 class="hasAnchor">
<a href="#cell-mixing-score" class="anchor"></a>Cell mixing score</h1>
<p>With SPIAT we can quantify how much two cell types are interacting through calculating a cell mixing score. This score was originally defined as the number of immune-tumor interactions divided by the number of immune-immune interactions <span class="citation">(Keren et al. 2018)</span>. SPIAT generalizes this method to allow calculation of any two cell phenotypes. <code>compute_mixing_score</code> returns the mixing score between a reference marker and a target marker. This mixing score is defined as the number of target-reference interactions/number of reference-reference interactions within a specified radius. The higher the score the greater the mixing of the two cell types.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/compute_mixing_score.html">compute_mixing_score</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_marker <span class="op">=</span> <span class="st">"CD4"</span>, target_marker <span class="op">=</span> <span class="st">"CD8"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Number of reference cells: 513"
## [1] "Number of target cells: 138"
## [1] "Number of reference-target interactions: 67"
## [1] "Number of reference-reference interactions: 412"</code></pre>
<pre><code>## [1] 0.1626214</code></pre>
</div>
<div id="bordering-cells" class="section level1">
<h1 class="hasAnchor">
<a href="#bordering-cells" class="anchor"></a>Bordering cells</h1>
<p>If we want to identify cells separating two distinct tissue areas, for example, cells at the tumour margin or at the border of tumour and stroma, we can use <code>identify_bordering_cells</code>. The algorithm is explained in the SPIAT paper <span class="citation">(Yang et al. 2020)</span>. Here we use tumour cells (AMACR) as the reference to identify the bordering cells but any cell type can be used.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/identify_bordering_cells.html">identify_bordering_cells</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_marker <span class="op">=</span> <span class="st">"AMACR"</span>,
                         rm_noise_radius <span class="op">=</span> <span class="fl">50</span>, radius <span class="op">=</span> <span class="fl">100</span>, lower_bound <span class="op">=</span> <span class="fl">0.05</span>,
                         upper_bound<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-32-1.png" width="700"></p>
</div>
<div id="cell-properties" class="section level1">
<h1 class="hasAnchor">
<a href="#cell-properties" class="anchor"></a>Cell properties</h1>
<p>We can use <code>measure_association_to_cell_properties</code> to compare two phenotypes for one of the cell properties, such as Cell.Area (see the HALO and InForm format section above for the cell properties available). Method options are density plot, boxplot, t test or wilcoxon test.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># boxplot</span>
<span class="fu"><a href="../reference/measure_association_to_cell_properties.html">measure_association_to_cell_properties</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                       phenotypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span><span class="op">)</span>,
                                       property <span class="op">=</span> <span class="st">"Cell.Area"</span>,
                                       method <span class="op">=</span> <span class="st">"box"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># t test</span>
<span class="fu"><a href="../reference/measure_association_to_cell_properties.html">measure_association_to_cell_properties</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                       phenotypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span><span class="op">)</span>,
                                       property <span class="op">=</span> <span class="st">"Cell.Area"</span>,
                                       method <span class="op">=</span> <span class="st">"t"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  CD3,CD4 and CD3,CD8
## t = 2.1766, df = 259.32, p-value = 0.03041
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##   2.783879 55.630562
## sample estimates:
## mean of x mean of y 
##  369.1637  339.9565</code></pre>
</div>
<div id="clusters-and-communities" class="section level1">
<h1 class="hasAnchor">
<a href="#clusters-and-communities" class="anchor"></a>Clusters and communities</h1>
<p>We can determine if there are aggregates (or a lack of aggregates) of a particular phenotype or combination of phenotypes. SPIAT can be used to identify two types of cell aggregates, clusters and communities.</p>
<p>Clusters are cell aggregates composed of non-tumour cells, often by immune cells. For the detection of clusters, <code>identify_cell_clusters</code> only considers cell phenotypes of interest defined by the user. Euclidean distances between cells are calculated, and pairs of cells with a distance less than a threshold are considered to be ‘interacting,’ with the rest being ‘non-interacting.’ Hierarchical clustering is then used to separate the clusters. We need to specify a radius. The radius corresponds to how lenient we are in defining clusters. A bigger radius would mean we are more likely to merge individual clusters. The radius is chosen based on what looks ‘reasonable.’ Cells not assigned to clusters (“free” cells) are assigned to Cluster_NA in the output table.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identify_cell_clusters.html">identify_cell_clusters</a></span><span class="op">(</span><span class="va">formatted_image</span>, phenotypes_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-34-1.png" width="700"></p>
<p>This plot shows clusters of CD3,CD4 and CD3,CD8 cells. Each number and colour corresponds to a distinct cluster. Black cells correspond to ‘free,’ un-clustered cells.</p>
<p>Users are recommended to test out different thresholds and then visualize the clustering results. But SPIAT also has <code>average_minimum_distance</code>, which calculates the average minimum distance between all cells in an image, and can be used as a starting point.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_minimum_distance.html">average_minimum_distance</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 15.92421</code></pre>
<p>Communities correspond to micro-niches or micro-ecosystems of cells that are located close to each other <span class="citation">(Jackson et al. 2020)</span>. The main distinction between clusters and communities is that the algorithm for the detection of communities used by <code>identify_cell_communities</code> does not take into account cell phenotype. Therefore, communities often consist of a combination of different cell types, including tumour cells. <em>dbscan</em> is used as the clustering algorithm to detect communities <span class="citation">(Hahsler, Piekenbrock, and Doran 2019)</span>. Cells without a phenotype are excluded.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">communities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identify_cell_communities.html">identify_cell_communities</a></span><span class="op">(</span><span class="va">formatted_image</span>, radius<span class="op">=</span><span class="fl">100</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-36-1.png" width="700"></p>
<p>This plot shows communities of cells in the tissue. Each number and colour corresponds to a distinct community.</p>
<p>We can visualize the cell composition of clusters or communities. This allows us to determine whether there are regions where cells of different types are interacting, or whether there is little mixing between celltypes. To do this, we can use <code>composition_of_clusters_and_communities</code> to obtain the percentages of cells with a specific marker within each cluster and the number of cells in the cluster.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clusters_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/composition_of_clusters_and_communities.html">composition_of_clusters_and_communities</a></span><span class="op">(</span><span class="va">clusters</span>, <span class="st">"Cluster"</span><span class="op">)</span>
<span class="va">clusters_vis</span> <span class="op">&lt;-</span> <span class="va">clusters_vis</span><span class="op">[</span><span class="va">clusters_vis</span><span class="op">$</span><span class="va">Total_number_of_cells</span> <span class="op">&gt;=</span><span class="fl">5</span>,<span class="op">]</span></code></pre></div>
<p>Then we can use <code>plot_composition_heatmap</code> to produce a heatmap showing the marker percentages within each cluster.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_composition_heatmap.html">plot_composition_heatmap</a></span><span class="op">(</span><span class="va">clusters_vis</span>, column_to_consider<span class="op">=</span><span class="st">"Cluster"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-38-1.png" width="700"></p>
<p>This plot shows that most clusters are composed of a mixture of CD3,CD4 and CD3,CD8 cells and some are more dominated by CD3,CD4 than others.</p>
<p>We can visualize the composition of the communities in a similiar way.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">communities_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/composition_of_clusters_and_communities.html">composition_of_clusters_and_communities</a></span><span class="op">(</span><span class="va">communities</span>, <span class="st">"Community"</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot_composition_heatmap.html">plot_composition_heatmap</a></span><span class="op">(</span><span class="va">communities_vis</span>, column_to_consider<span class="op">=</span><span class="st">"Community"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-39-1.png" width="700"></p>
<p>This plot shows that several communities detected have a combination of tumour (AMACR) and immune cells while some are dominated by tumour or immune cells.</p>
</div>
<div id="reproducibility" class="section level1">
<h1 class="hasAnchor">
<a href="#reproducibility" class="anchor"></a>Reproducibility</h1>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R Under development (unstable) (2021-01-21 r79854)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.1 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] SPIAT_0.99.0                SingleCellExperiment_1.13.6
##  [3] SummarizedExperiment_1.21.1 Biobase_2.51.0             
##  [5] GenomicRanges_1.43.3        GenomeInfoDb_1.27.5        
##  [7] IRanges_2.25.6              S4Vectors_0.29.6           
##  [9] BiocGenerics_0.37.0         MatrixGenerics_1.3.1       
## [11] matrixStats_0.58.0          BiocStyle_2.19.1           
## 
## loaded via a namespace (and not attached):
##  [1] bitops_1.0-6           fs_1.5.0               bit64_4.0.5           
##  [4] RColorBrewer_1.1-2     httr_1.4.2             rprojroot_2.0.2       
##  [7] tools_4.1.0            R6_2.5.0               lazyeval_0.2.2        
## [10] colorspace_2.0-0       GetoptLong_1.0.5       tidyselect_1.1.0      
## [13] gridExtra_2.3          bit_4.0.4              compiler_4.1.0        
## [16] textshaping_0.2.1      Cairo_1.5-12.2         desc_1.2.0            
## [19] DelayedArray_0.17.7    plotly_4.9.3           labeling_0.4.2        
## [22] bookdown_0.21          scales_1.1.1           dittoSeq_1.3.5        
## [25] ggridges_0.5.3         pkgdown_1.6.1          systemfonts_1.0.0     
## [28] stringr_1.4.0          apcluster_1.4.8        digest_0.6.27         
## [31] dbscan_1.1-5           rmarkdown_2.6          XVector_0.31.1        
## [34] pkgconfig_2.0.3        htmltools_0.5.1.1      highr_0.8             
## [37] fastmap_1.1.0          htmlwidgets_1.5.3      rlang_0.4.10          
## [40] GlobalOptions_0.1.2    farver_2.0.3           shape_1.4.5           
## [43] generics_0.1.0         jsonlite_1.7.2         crosstalk_1.1.1       
## [46] vroom_1.4.0            mmand_1.6.1            gtools_3.8.2          
## [49] dplyr_1.0.4            RCurl_1.98-1.2         magrittr_2.0.1        
## [52] GenomeInfoDbData_1.2.4 Matrix_1.3-2           Rcpp_1.0.6            
## [55] munsell_0.5.0          lifecycle_0.2.0        stringi_1.5.3         
## [58] yaml_2.2.1             zlibbioc_1.37.0        plyr_1.8.6            
## [61] grid_4.1.0             ggrepel_0.9.1          crayon_1.4.0          
## [64] lattice_0.20-41        cowplot_1.1.1          circlize_0.4.12       
## [67] knitr_1.31             ComplexHeatmap_2.7.5   pillar_1.4.7          
## [70] rjson_0.2.20           reshape2_1.4.4         glue_1.4.2            
## [73] evaluate_0.14          data.table_1.13.6      BiocManager_1.30.10   
## [76] png_0.1-7              vctrs_0.3.6            gtable_0.3.0          
## [79] RANN_2.6.1             purrr_0.3.4            tidyr_1.1.2           
## [82] clue_0.3-58            assertthat_0.2.1       cachem_1.0.1          
## [85] ggplot2_3.3.3          xfun_0.20              pracma_2.3.3          
## [88] ragg_0.4.1             viridisLite_0.3.0      tibble_3.0.6          
## [91] pheatmap_1.0.12        memoise_2.0.0          cluster_2.1.0         
## [94] ellipsis_0.3.1</code></pre>
</div>
<div id="author-contributions" class="section level1">
<h1 class="hasAnchor">
<a href="#author-contributions" class="anchor"></a>Author Contributions</h1>
<p>AT, TY, YF, VO, MD are authors of the package code. MD wrote the vignette. AT designed the package.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-hahsler2019dbscan" class="csl-entry">
Hahsler, Michael, Matthew Piekenbrock, and Derek Doran. 2019. <span>“Dbscan: Fast Density-Based Clustering with r.”</span> <em>Journal of Statistical Software</em> 91 (1): 1–30.
</div>
<div id="ref-jackson2020single" class="csl-entry">
Jackson, Hartland W, Jana R Fischer, Vito RT Zanotelli, H Raza Ali, Robert Mechera, Savas D Soysal, Holger Moch, et al. 2020. <span>“The Single-Cell Pathology Landscape of Breast Cancer.”</span> <em>Nature</em> 578 (7796): 615–20.
</div>
<div id="ref-keren2018structured" class="csl-entry">
Keren, Leeat, Marc Bosse, Diana Marquez, Roshan Angoshtari, Samir Jain, Sushama Varma, Soo-Ryum Yang, et al. 2018. <span>“A Structured Tumor-Immune Microenvironment in Triple Negative Breast Cancer Revealed by Multiplexed Ion Beam Imaging.”</span> <em>Cell</em> 174 (6): 1373–87.
</div>
<div id="ref-yang2020spiat" class="csl-entry">
Yang, Tianpei, Volkan Ozcoban, Anu Pasam, Nikolce Kocovski, Angela Pizzolla, Yu-Kuan Huang, Greg Bass, et al. 2020. <span>“SPIAT: An r Package for the Spatial Image Analysis of Cells in Tissues.”</span> <em>bioRxiv</em>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Anna Trigos, Tom  Yang, Yuzhou  Feng, Volkan  Ozcoban, Maria  Doyle.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
